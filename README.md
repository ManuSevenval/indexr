# Indexr
Dynamic index modules for your ES6 submodules. 

## Background

ES6 modules are great but what if you have dynamic modules that should be autoloaded?

You can try something like this in your index.js file for your modules folder:

```javascript
export default fs
  .readdirSync(moduleFolder)
  .filter((listing) => {
    // is it a folder? Just asking this question requires try catch!!
    try {
      return fs.statSync(p).isDirectory() 
        && fs.statSync(path.resolve(p, 'index.js')).isFile();
    } catch (e) {
      return false;
    }
  })
  .map((listing) => {
    // sneekily require the module breaking ES6 module loading in the process...
    return require(path.resolve(moduleFolder, listing))
  })
```

This works but require is not part of the ES6 modules spec. ES6 imports are declarative and meant for static analysis. They cannot be dynamic.

But that doesn't stop us needing to load things simply and dynamically does it? Assuming we have a folder full of routes modules we want to be able to do the following:

```javascript
import routes from './routes';
import express from 'express';

const app = express();

// Autoload all routes from within the routes folder
routes.map((route) => {
  app.use(route);
});

//... do other things
```

The answer has been to manually maintain a root module that exports your submodules as an array. 

```javascript
// ./routes/index.js
import api from './api';
import products from './products';
import errors from './errors';

export default [
  api,
  products,
  errors,
];
```

This is great because it is still statically analysable and we can import our modules as an array by simply using:

```javascript
import routes from './routes';
```

However this leads to errors if you forget to update your root module and maintainence more difficult especially if you have many modules to import.

Indexr is designed to solve this problem by automatically generating index root modules from submodules.

# Installation

<!-- Install globally and refer to indexr from the bash prompt.

```bash
npm install indexr -g
```
 -->
Install locally and use the node API
<!--or use indexr in npm scripts.-->

```bash
npm install indexr --save
```
<!--
If #2, add `./node_modules/.bin` to your path (recommended). This method means you have access to the binaries for all local npm modules.

```bash
# add node modules .bin folder for local executables
PATH=$PATH:./node_modules/.bin
``` -->

# Usage

Assuming we have a folder tree like this:

```bash
/folder
 ├── bar
 ├── baz
 └── foo
```

We run this in a node file somewhere:

```javascript
import indexr from 'indexr';
indexr('/path/to/folder', 'index.js');
```

It will create a file called `/path/to/folder/index.js` that contains the following:

```javascript
/**
  This file is autogenerated by indexr.
  Check this file into source control.
  Do not edit this file.
  For more information: http://github.com/ryardley/indexr
**/
import foo from './foo';
import bar from './bar';
import baz from './baz';
export default [
  foo, 
  bar, 
  baz
];
/** End autogenerated content **/
```

If the es5 flag is set Indexr can export the template in es5/common js style.

```javascript
var foo = require('./foo');
var bar = require('./bar');
var baz = require('./baz');
module.exports = [foo, bar, baz];
```

We can also filter which modules and entry files we want by setting some options.

```javascript
indexr('/path/to/folder', 'index.js', {
  include: '*/server.js',
});
```

This will only include modules which contain `server.js` files.

```javascript
indexr('/path/to/folder', 'index.js', {
  include: '*/server.js',
  directImport: true,
  exts: ['js']
});
```

By using the `directImport` flag it will include the searched files in the import statements:

```javascript
import foo from './foo/server';
import bar from './bar/server';
export default [foo, bar];
```

Node API signature

```javascript
indexr(folder, [outputFile,] options)
```

| argument            | notes                     |
| ------------------- | ------------- |
| folder              | The folder to analyze |
| outputFile (opt)    | The name and path to the outputFile relative to the folder. If not included indexr will simply return a string with the file index instead of writing it to a file. |
| options             | An object containing configuration options  |

### Available options
| option      | notes                     |
| ------------- | --------------------------------------------- |
| include       | Glob or an array of globs. |
| es5           | Boolean flag to use es5 commonjs style modules over es6. This is overridden if a template function is provided |
| template      | Either a string or a function. If a string valid values are 'es5' or 'esnext'. If a template function the function should takes an array of relative module paths and output the module file as a string |


### Include
`include` can be a glob string or an array of globs. The following will index any module in the `/app` folder that contains a `server.js` file or an `index.js` file.

```javascript
indexr('/app', 'server.js', {
  include: ['*/server.js', '*/index.js']
});
```

## Node API example

```javascript
import indexr from 'indexr';

indexr('./app', 'server-index.js', {filter: ['./*/server.js']})
```

# Roadmap

* CLI
* [Gulp Plugin](http://github.com/ryardley/gulp-indexr)
